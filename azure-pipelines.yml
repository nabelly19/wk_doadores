trigger:
  branches:
    include:
      - develop
      - release/*
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  webAppName: 'meu-backend-app'         # Substitua pelo nome real da sua Web App no Azure
  environmentName: 'simulate-java'
  dryRun: 'true'                        # Flag que ativa o deploy simulado

stages:
- stage: Build
  displayName: Build
  jobs:
  - job: MavenBuild
    displayName: 'Maven Package'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Maven@4
      inputs:
        mavenPomFile: 'back/pom.xml'
        mavenOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.17'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        goals: 'clean package'
    - task: CopyFiles@2
      inputs:
        SourceFolder: 'back/target'
        Contents: '*.jar'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
    - publish: '$(Build.ArtifactStagingDirectory)'
      artifact: drop

- stage: Test
  displayName: Test
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: RunTests
    displayName: 'Run Unit Tests'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "üîç Executando testes unit√°rios com Maven..."
        mvn test -f back/pom.xml
      displayName: 'Executar Testes Unit√°rios'

- stage: Deploy
  displayName: Deploy (simulado)
  dependsOn: Test
  condition: succeeded()
  jobs:
  - deployment: SimulatedDeploy
    displayName: 'Deploy Simulado para Azure'
    environment: $(environmentName)
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
          - script: |
              echo "üöÄ [SIMULADO] Deploy para Web App Linux: $(webAppName)"
              if [ "$(dryRun)" = "true" ]; then
                echo "‚úÖ dryRun ativo: N√ÉO ser√° executado deploy real."
                echo "üì¶ Artefato dispon√≠vel em: $(Pipeline.Workspace)/drop"
                echo "‚û°Ô∏è Ap√≥s deploy real, Swagger estaria dispon√≠vel em: https://$(webAppName).azurewebsites.net/swagger"
                echo "‚úÖ Aplica√ß√£o gravaria dados no MySQL."
              else
                echo "‚ö†Ô∏è Modo simulado desativado ‚Äî aqui seria usado AzureWebApp@1 ou AzureRmWebAppDeployment@4"
              fi
            displayName: 'Simular Deploy'
