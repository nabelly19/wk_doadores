trigger:
  branches:
    include:
      - develop
      - release/*
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  BACKEND_DIR: 'back'
  BUILD_ARTIFACT: '$(Pipeline.Workspace)/drop'
  dryRun: 'true'

stages:
- stage: Build
  displayName: '1. Build'
  jobs:
  - job: Build
    steps:
    - checkout: self
    - script: |
        echo "ğŸ“ Entrando em $(BACKEND_DIR)"
        cd $(BACKEND_DIR)
    - task: Maven@3
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'package'
        options: '-DskipTests'
      displayName: 'ğŸ¯ Maven Package'
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)/drop'
        artifact: backend-drop

- stage: Test
  displayName: '2. Test'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: UnitTests
    steps:
    - checkout: self
    - script: |
        echo "âœ… Executando testes unitÃ¡rios"
        cd $(BACKEND_DIR)
    - task: Maven@3
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'test'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
      displayName: 'ğŸ§ª Maven Testes'

- stage: Deploy
  displayName: '3. Deploy (simulado)'
  dependsOn: Test
  condition: succeeded()
  jobs:
  - deployment: SimDeploy
    displayName: 'Deploy Simulado'
    environment: 'simulate-backend'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: backend-drop
          - script: |
              echo "ğŸš€ [SIMULADO] Deploy Java no Azure"
              if [ "$(dryRun)" = "true" ]; then
                echo "ğŸ›‘ Modo dryRun ativo: nÃ£o haverÃ¡ deploy real."
                echo "Artefatos prontos em: $(Pipeline.Workspace)/drop"
                echo "âœ… Swagger estaria disponÃ­vel apÃ³s deploy real."
                echo "âœ… AplicaÃ§Ã£o gravaria dados no MySQL."
              else
                echo "âš ï¸ dryRun desativado: aqui ocorreria o deploy real."
              fi
