trigger:
  branches:
    include:
      - develop
      - release/*
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  BACKEND_DIR: 'back'
  BUILD_ARTIFACT: '$(Pipeline.Workspace)/drop'
  dryRun: 'true'

stages:
- stage: Build
  displayName: '1. Build'
  jobs:
  - job: Build
    steps:
    - checkout: self

    # Maven Package usando o caminho correto do pom.xml dentro de back/
    - task: Maven@3
      inputs:
        mavenPomFile: '$(BACKEND_DIR)/pom.xml'
        goals: 'package'
        options: '-DskipTests'
      displayName: 'üéØ Maven Package'

    # Copiar os JARs gerados para a pasta BUILD_ARTIFACT (drop)
    - script: |
        echo "üì¶ Copiando artefatos para $(BUILD_ARTIFACT)"
        mkdir -p $(BUILD_ARTIFACT)
        cp $(BACKEND_DIR)/target/*.jar $(BUILD_ARTIFACT)/
      displayName: 'üìÇ Copiar artefatos'

    # Publicar artefatos para os pr√≥ximos est√°gios
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(BUILD_ARTIFACT)'
        artifact: backend-drop

- stage: Test
  displayName: '2. Test'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: UnitTests
    steps:
    - checkout: self

    - script: |
        echo "‚úÖ Executando testes unit√°rios"
      displayName: 'Preparar testes'

    # Rodar testes Maven usando o pom.xml correto
    - task: Maven@3
      inputs:
        mavenPomFile: '$(BACKEND_DIR)/pom.xml'
        goals: 'test'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
      displayName: 'üß™ Maven Testes'

- stage: Deploy
  displayName: '3. Deploy (simulado)'
  dependsOn: Test
  condition: succeeded()
  jobs:
  - deployment: SimDeploy
    displayName: 'Deploy Simulado'
    environment: 'simulate-backend'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: backend-drop

          - script: |
              echo "üöÄ [SIMULADO] Deploy Java no Azure"
              if [ "$(dryRun)" = "true" ]; then
                echo "üõë Modo dryRun ativo: n√£o haver√° deploy real."
                echo "Artefatos prontos em: $(Pipeline.Workspace)/drop"
                echo "‚úÖ Swagger estaria dispon√≠vel ap√≥s deploy real."
                echo "‚úÖ Aplica√ß√£o gravaria dados no MySQL."
              else
                echo "‚ö†Ô∏è dryRun desativado: aqui ocorreria o deploy real."
              fi
